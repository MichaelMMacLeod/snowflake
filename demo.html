<!DOCTYPE html>
<html>

<head>
  <title>Demo</title>
  <style>
    :root {
      --SF-color-background: #111111;
      --SF-color-foreground: #ffffff;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --SF-color-background: #ffffff;
        --SF-color-foreground: #111111;
      }
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --SF-color-background: #111111;
        --SF-color-foreground: #ffffff;
      }
    }

    html {
      color-scheme: light dark;
      font-family: 'Notto Sans', sans-serif;
    }

    #graphAndControlsContainer {
      width: 100%;
    }

    #controlsContainer {
      margin-top: 0.5em;
      margin-left: 2.5em;
      margin-right: 2.5em;
    }

    #speedContainer {
      float: right;
      display: flex;
      width: 15em;
    }

    #speed {
      width: 12em;
      flex-grow: 2;
      margin-right: 1em;
    }

    .controlButton {
      width: 4em;
    }

    .controlCheckbox {
      margin-left: 1em;
    }

    #snowflakeAndGraphContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #snowflakeContainer {
      height: calc(800px * sqrt(2));
    }
  </style>
</head>

<body>
  <script src="dist/sf_snowflake.js"></script>
  <script src="dist/sf_graph.js"></script>
  <div id="snowflakeAndGraphContainer">
    <div id="graphAndControlsContainer">
      <div id="graphContainer"></div>
      <div id="controlsContainer">
        <button type="button" id="togglePlayingButton" class="controlButton">
          Pause
        </button>
        <button type="button" id="resetButton" class="controlButton">
          Reset
        </button>
        <input type="checkbox" id="spinCheckbox" name="spin" class="controlCheckbox" checked />
        <label for="spin">Spin</label>
        <div id="speedContainer">
          <input id="speed" type="range" name="speed" min="0" max="4" value="1" step="1" autocomplete="off" />
          <label id="speedLabel" for="speed">Speed</label>
        </div>
      </div>
    </div>
    <div id="snowflakeContainer"></div>
  </div>
  <script>
    customElements.define('sf-snowflake', sf_snowflake.default);
    customElements.define('sf-graph', sf_graph.default);
    const snowflake = document.createElement('sf-snowflake');
    const graph = document.createElement('sf-graph');
    document.getElementById('graphContainer').appendChild(graph);
    document.getElementById('snowflakeContainer').appendChild(snowflake);
    const config = {
      graph: {},
      snowflake: {},
    };
    function configureGraph() { graph.configure(config.graph); }
    function configureSnowflake() { snowflake.configure(config.snowflake); }

    snowflake.canvas().style.position = 'relative';
    snowflake.canvas().style.zIndex = -1;
    const spinAnimation = snowflake.canvas().animate(
      [
        { transform: 'rotate(0deg)' },
        { transform: 'rotate(360deg)' },
      ],
      {
        duration: 1000 * 20,
        iterations: Infinity,
      }
    );

    const urlParams = new URLSearchParams(window.location.search);
    const defaultSnowflakeID = (() => {
      const result = urlParams.get('id');
      if (result === null || !snowflake.isValidSnowflakeId(result)) {
        return '17827239998'
      }
      return result;
    })();

    config.graph = {
      snowflakeID: defaultSnowflakeID,
      aspectRatio: 3,
      percentGrown: 0,
      handleMovedCallback: snowflakeID => {
        config.snowflake.snowflakeID = snowflakeID;
        configureSnowflake();
        urlParams.set('id', snowflakeID);
        window.history.replaceState({}, '', '?' + urlParams.toString())
      },
    };

    function syncGraphToSnowflake() {
      config.graph.snowflakeID = config.snowflake.snowflakeID;
      config.graph.percentGrown = snowflake.percentGrown();
      configureGraph();
    }

    const darkModeQueryList = window.matchMedia('(prefers-color-scheme: dark)');

    const defaultTargetGrowthTimeMS = 10000;

    config.snowflake = {
      playing: true,
      snowflakeID: defaultSnowflakeID,
      upsCap: 1000000000,
      targetGrowthTimeMS: defaultTargetGrowthTimeMS,
      isLightTheme: !darkModeQueryList.matches,
      finishedGrowingCallback: () => { },
      updatedCallback: () => {
        syncGraphToSnowflake();
      },
      resetCallback: () => {
        syncGraphToSnowflake();
      },
    };
    configureGraph();
    configureSnowflake();

    const speedElement = document.getElementById('speed');
    speedElement.addEventListener('change', e => {
      let value = Math.min(4, Math.max(0, e.target.value));
      value = Math.round(value);
      value = (() => {
        switch (value) {
          case 0: return 20000;
          case 1: return defaultTargetGrowthTimeMS;
          case 2: return 2500;
          case 3: return 313;
          case 4: return 0;
          default: return 0;
        }
      })();
      config.snowflake.targetGrowthTimeMS = value;
      configureSnowflake();
    });

    const spinCheckbox = document.getElementById('spinCheckbox');
    spinCheckbox.addEventListener('change', e => {
      if (e.target.checked && config.snowflake.playing) {
        spinAnimation.play();
      } else {
        spinAnimation.cancel();
      }
    });

    const togglePlayingButton = document.getElementById('togglePlayingButton');
    togglePlayingButton.addEventListener('click', _ => {
      config.snowflake.playing = !config.snowflake.playing;
      if (config.snowflake.playing) {
        togglePlayingButton.textContent = 'Pause';
        if (spinCheckbox.checked) {
          spinAnimation.play();
        }
      } else {
        togglePlayingButton.textContent = 'Play';
        spinAnimation.pause();
      }
      configureSnowflake();
    });

    const resetButton = document.getElementById('resetButton');
    resetButton.addEventListener('click', _ => {
      snowflake.reset();
    });

    darkModeQueryList.addEventListener('change', e => {
      config.snowflake.isLightTheme = !config.snowflake.isLightTheme;
      configureSnowflake();
    });
  </script>
</body>

</html>