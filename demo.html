<!DOCTYPE html>
<html>

<head>
  <title>Demo</title>
  <style>
    :root {
      --SF-color-background: #111111;
      --SF-color-foreground: #ffffff;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --SF-color-background: #ffffff;
        --SF-color-foreground: #111111;
      }
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --SF-color-background: #111111;
        --SF-color-foreground: #ffffff;
      }
    }

    html {
      color-scheme: light dark;
      font-family: 'Notto Sans', sans-serif;
    }

    #graphAndControlsContainer {
      width: 60em;
    }

    #controlsContainer {
      margin-top: 0.5em;
      margin-left: 2.5em;
      margin-right: 2.5em;
    }

    #speedContainer {
      float: right;
      display: flex;
      width: 15em;
    }

    #speed {
      width: 12em;
      flex-grow: 2;
      margin-right: 1em;
    }

    .controlButton {
      width: 4em;
    }

    #snowflakeAndGraphContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  </style>
</head>

<body>
  <script src="dist/sf_snowflake.js"></script>
  <script src="dist/sf_graph.js"></script>
  <div id="snowflakeAndGraphContainer">
    <div id="graphAndControlsContainer">
      <div id="graphContainer"></div>
      <div id="controlsContainer">
        <button type="button" id="togglePlayingButton" class="controlButton">
          Pause
        </button>
        <button type="button" id="resetButton" class="controlButton">
          Reset
        </button>
        <div id="speedContainer">
          <input id="speed" type="range" name="speed" min="0" max="4" value="2" step="1" list="markers" />
          <label id="speedLabel" for="speed">Speed</label>
        </div>
      </div>
    </div>
    <div id="snowflakeContainer"></div>
  </div>
  <script>
    const darkModeQueryList = window.matchMedia('(prefers-color-scheme: dark)');
    darkModeQueryList.addEventListener('change', e => {
      console.log('toggled');
    });

    customElements.define('sf-snowflake', sf_snowflake.default);
    customElements.define('sf-graph', sf_graph.default);
    const snowflake = document.createElement('sf-snowflake');
    const graph = document.createElement('sf-graph');
    document.getElementById('graphContainer').appendChild(graph);
    document.getElementById('snowflakeContainer').appendChild(snowflake);
    const config = {
      graph: {},
      snowflake: {},
    };
    function configureGraph() { graph.configure(config.graph); }
    function configureSnowflake() { snowflake.configure(config.snowflake); }

    const urlParams = new URLSearchParams(window.location.search);
    const defaultSnowflakeID = (() => {
      const result = urlParams.get('id');
      if (result === null || !snowflake.isValidSnowflakeId(result)) {
        return '17827239998'
      }
      return result;
    })();

    config.graph = {
      snowflakeID: defaultSnowflakeID,
      aspectRatio: 3,
      percentGrown: 0,
      handleMovedCallback: snowflakeID => {
        config.snowflake.snowflakeID = snowflakeID;
        configureSnowflake();
        urlParams.set('id', snowflakeID);
        window.history.replaceState({}, '', '?' + urlParams.toString())
      },
    };

    function syncGraphToSnowflake() {
      config.graph.snowflakeID = config.snowflake.snowflakeID;
      config.graph.percentGrown = snowflake.percentGrown();
      configureGraph();
    }
    config.snowflake = {
      playing: true,
      snowflakeID: defaultSnowflakeID,
      upsCap: 1000000000,
      targetGrowthTimeMS: 1250,
      finishedGrowingCallback: () => { },
      updatedCallback: () => {
        syncGraphToSnowflake();
      },
      resetCallback: () => {
        syncGraphToSnowflake();
      }
    };
    configureGraph();
    configureSnowflake();

    const speedElement = document.getElementById('speed');
    speedElement.addEventListener('change', e => {
      let value = Math.min(4, Math.max(0, e.target.value));
      value = Math.round(value);
      value = (() => {
        switch (value) {
          case 0: return 10000;
          case 1: return 5000;
          case 2: return 1250;
          case 3: return 156;
          case 4: return 0;
          default: return 0;
        }
      })();
      config.snowflake.targetGrowthTimeMS = value;
      configureSnowflake();
    });

    const togglePlayingButton = document.getElementById('togglePlayingButton');
    togglePlayingButton.addEventListener('click', _ => {
      config.snowflake.playing = !config.snowflake.playing;
      if (config.snowflake.playing) {
        togglePlayingButton.textContent = 'Pause';
      } else {
        togglePlayingButton.textContent = 'Play';
      }
      configureSnowflake();
    });

    const resetButton = document.getElementById('resetButton');
    resetButton.addEventListener('click', _ => {
      snowflake.reset();
    });
  </script>
</body>

</html>